---
title: "Reproducibility analyses"
author: "Molly Lewis and Christina Bergmann"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: united
    highlight: tango
    toc: true
    number_sections: true
    code_folding: hide
---
  
```{r, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, fig.height = 5, echo = TRUE,
                      warning = FALSE, message = FALSE, cache = TRUE)
ggplot2::theme_set(langcog::theme_mikabr(base_family = "Ubuntu"))
source("../dashboard/global.R", chdir = TRUE)
```

```{r, echo=FALSE, cache=FALSE}
library(metafor)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(langcog)
```

# Introduction

# p-curve 
Corrects for selective reporting on the basis of significance (fewer insignificant results; Simonsohn, Nelson, & Simmons, 2014)
```{r}
# calculate degrees of freedom based on Ns and design (within = n_1-1, between = n_1 + n_2 - 2
pcurve.data = 
  select(all_data, dataset, unique_ID, t, F, n_1, n_2, participant_design, d) %>%
  filter(!is.na(t)|!is.na(F)) %>%
  mutate(df = ifelse(participant_design == "between", n_1 + n_2-2, n_1-1))
         
#summary(pcurve.data$df)

#pcurve.df %>% 
#  filter(participant_design == "between") %>% 
#  data.frame()

# code from Simonsohn, Nelson, & Simmons (2014) appendix
loss = function(t_obs,df_obs,d_est) { 
  t_obs=abs(t_obs)
  p_obs=2*(1-pt(t_obs,df=df_obs)) 
  t.sig=subset(t_obs,p_obs<.05)
  df.sig=subset(df_obs,p_obs<.05)
  ncp_est=sqrt((df.sig+2)/4)*d_est 
  tc=qt(.975,df.sig) 
  power_est=1-pt(tc,df.sig,ncp_est)
  p_larger=pt(t.sig,df=df.sig,ncp=ncp_est)
  ppr=(p_larger-(1-power_est))/power_est 
  KSD=ks.test(ppr,punif)$statistic 
  return(KSD)
}

plotloss=function(t_obs,df_obs,dmin,dmax, titlestring) { 
  loss.all=c()
  di=c()
  for (i in 0:((dmax-dmin)*100)) {
    d = dmin + i/100
    di = c(di,d)
    options(warn = -1)
    loss.all=c(loss.all,loss(df_obs=df_obs,t_obs=t_obs,d_est=d)) 
    options(warn = 0)
  }
    
  imin=match(min(loss.all),loss.all) 
  dstart=dmin+imin/100
  dhat=optimize(loss,c(dstart-.1, dstart+.1), df_obs=df_obs,t_obs=t_obs)

  plot(di,
       loss.all, xlab="Effect size\nCohen-d", 
       ylab="Loss (D stat in KS test)",
       ylim=c(0,1),
       main=paste("Effect size fit ", titlestring, sep = "\n"))
  points(dhat$minimum,dhat$objective,pch=19,col="red",cex=2) 
  text(dhat$minimum,dhat$objective+.28,
       paste0("p-curveâ€™s estimate of effect size:\nd=",round(dhat$minimum,3)),col="red") 
  return(dhat$minimum)
} 

plotloss(pcurve.data$t, pcurve.data$df, dmin=-2, dmax =2, "All data")

datasets = unique(all_data$dataset)

for (i in 2:length(datasets)) {
  my_data = pcurve.data[pcurve.data$dataset ==  datasets[i],]
  #print(length(my_data$t)) 
  plotloss(my_data$t, my_data$df, dmin=-2, dmax =2, my_data$dataset[1])
  print(my_data$dataset[1])
  print(median(abs(my_data$d), na.rm=TRUE))
}

```


# Trim-and-fill 
Corrects for selective reporting on the basis of effect size (fewer small effects; Duval & Tweedie, 2000a, 2000b)
```{r}
### fit random-effects model and plot
datasets = unique(all_data$dataset)

for (i in 1:length(datasets)) {
  my_data = all_data[all_data$dataset ==  datasets[i],]
  res <- rma(d, d_var, data = my_data)
  taf <- trimfill(res)
  funnel(taf, main = my_data$dataset[1])
}

res <- rma(d, d_var, data = all_data)
taf <- trimfill(res)
funnel(taf, main = "all data")
```

# Exclusions

Q1: Does the number of excluded infants affect effect sizes?


```{r Exclusions_nExcluded, warning=FALSE, tidy=TRUE}
datasets = unique(all_data$dataset)

for (i in 1:length(datasets)) {
  my_data = all_data[all_data$dataset ==  datasets[i],]
  ggplot() + title()
}

res <- rma(d, d_var, data = all_data)
taf <- trimfill(res)
funnel(taf, main = "all data")

```

Q2: To correct for total number of infants tested, what about proportion excluded?





# Publication Bias (years vs. effect sizes)

# Lab-based moderators (first author, last author, diversity)
Do effect sizes differ as a function of first author?
```{r}

all_data$first_author = unlist(lapply(all_data$short_cite, 
                                     function(x) unlist(strsplit(x, '[&,(]|et|and'))[1]))

all_data$first_author= str_replace_all(all_data$first_author,"[[:punct:]]","") 
all_data$first_author = as.factor(all_data$first_author)

for (i in 1:length(datasets)) {
  my_data = all_data[all_data$dataset ==  datasets[i],]
  
  freqs = my_data %>% 
          group_by(first_author) %>%
          summarise(count=n()) %>%
          filter(count > 3) # filter so only look at authors with >x studies
  
  p = ggplot(freqs, aes(y = count, x = reorder(first_author, -count))) +
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("First author") +
    ggtitle(datasets[i])
  
  print(p)
  
  m = rma(d ~ first_author + mean_age, vi = d_var, slab = as.character(unique_ID),
          data = my_data, method = "REML")
  print(m)
}
```

Do effect sizes differ as a function of last author?
This needs some clean up.
```{r}
all_data$last_author = unlist(lapply(all_data$short_cite, 
                                     function(x) unlist(strsplit(x, '[&(]|^|'))[2]))

all_data$last_author= str_replace_all(all_data$last_author,"[[:punct:]]","") 
all_data$last_author = as.factor(all_data$last_author)

for (i in 1:length(datasets)) {
  my_data = all_data[all_data$dataset ==  datasets[i],]
  
  freqs = my_data %>% 
          group_by(last_author) %>%
          summarise(count=n())

  p = ggplot(freqs, aes(y = count, x = reorder(last_author, -count))) +
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("Last author") +
    ggtitle(datasets[i])
  
  print(p)
  
  m = rma(d ~ last_author + mean_age, vi = d_var, slab = as.character(unique_ID), 
          data = my_data, method = "REML")
  print(m)
}
```
This is kind of messy -- is there a cleaner analysis to do here?

Would be nice to also do number of authors here. 
* minimum threshold of papers

# Data availability/reporting standards
Here we're intersted in describing the extent to which papers report all statistics that are desirable from the perspective of meta-analysis (i.e. t/F, M, SD, d)
```{r}

counts = all_data %>%
            summarise(test_statistic = sum(!is.na(t) | !is.na(F)),
                      means = sum(!is.na(x_1)),
                      SD = sum(!is.na(SD_1)),
                      d = sum(!is.na(d)),
                      age_range = sum(!is.na(age_range_1)),
                      gender = sum(!is.na(gender_1))) %>%
            gather("coded_variable", "n") %>%
            mutate(coded = "coded") %>%
            mutate(total = nrow(all_data))

counts = counts %>%
             mutate(n = total - n, 
                    coded = "uncoded")  %>%
             bind_rows(counts) %>%
             mutate(n_lab = ifelse(coded == "coded", n, ""))

ggplot(counts) + 
  geom_bar(aes(x = coded_variable, 
               y = n/total,
               fill = coded,
              order = coded), 
           stat = "identity") + 
  ylim(0,1) + 
  ylab("Number coded") + 
  xlab("Coded variable") + 
  ggtitle("All data") + 
   annotate("text", x = 1, y = .9, 
            label = paste("N =", counts$total[1]), size = 6) + 
  scale_fill_manual(values=c( "lightgreen", "grey")) + 
  geom_text(aes(label = n_lab, x = coded_variable, y = n/total -.06) )+
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
       axis.line = element_line(colour = "black"),
       text = element_text(size=20))

```

By MA
```{r}
counts = all_data %>%
            group_by(dataset) %>%
            summarise(test_statistic = sum(!is.na(t) | !is.na(F)),
                      means = sum(!is.na(x_1)),
                      SD = sum(!is.na(SD_1)),
                      d = sum(!is.na(d)),
                      age_range = sum(!is.na(age_range_1)),
                      gender = sum(!is.na(gender_1)),
                      total = n()) %>%
            gather(coded_variable, n, -dataset, -total) %>%
            mutate(coded = "coded") 

counts = counts %>%
             mutate(n = total - n, 
                    coded = "uncoded")  %>%
             bind_rows(counts) %>%
             mutate(n_lab = ifelse(coded == "coded", n, ""))

ggplot(counts) + 
  geom_bar(aes(x = coded_variable, 
               y = n/total,
               fill = coded,
              order = coded), 
           stat = "identity") + 
  facet_wrap(~dataset, nrow=3, ncol=2) +
  ylim(0,1) + 
  ylab("Number coded") + 
  xlab("Coded variable") + 
  scale_fill_manual(values = c("lightgreen", "grey")) + 
  geom_text(aes(label = n_lab,
              x = coded_variable, 
              y = n/total -.06)) +
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        text = element_text(size=20),
        strip.background  = element_blank(), 
        axis.text.x = element_text(angle = 30, hjust = 1))

#annotate("text", x = 1, y = .9, 
           # label = paste("N =", totals), size = 6) + 
#totals_text = all_data %>%
      #      group_by(dataset) %>%
      #     summarise(total = n())%>%
      #     mutate(coded_variable = 1,
      #             lab = paste("N =", total))
```
# Meta-analytic power
# Individual meta-analysis power
# Published vs. unpublished ES's
