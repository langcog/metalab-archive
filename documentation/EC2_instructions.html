<!DOCTYPE html>
<html>
<title></title>

<xmp theme="cosmo" style="display:none;">

How to set-up an EC2 instance for dataset caching script
========================================================

The MetaLab shiny app pulls in data from csv files in the `data/` directory. An R script, `scripts/cache_datasets.R`,
loads all the datasets listed in `datasets.json` from Google Docs, checks that they have all the required columns
and valid values, and if so writes new csv files of their contents. For any aspects of the datasets that don't pass
these checks, it prints out an informative message. A bash script, `scripts/cache_datasets.sh`, is a wrapper that runs
the R script, saves the resulting messages to a log file called `log/%Y-%m-%dT%H:%M:%S`, sends each of the messages to
LangCog's Slack under the `#metalab-log` channel, and pushes any changes in the data files to GitHub. These
instructions describe how to set up an Amazon EC2 instance that will use crontab to run the script every night.

- launch an Ubuntu instance from EC2 console on langcog's account, using the `metalab` key pair

- get a `metalab.pem` file from someone who has it

- ssh into the server

		$ ssh -i metalab.pem ubuntu@<IP>

- generate ssh keys for GitHub:

		$ cd ~/
		$ ssh-keygen -t rsa
  copy the contents of `~/.ssh/id_rsa.pub`

  go to GitHub, login to an account that has access to `langcog/metalab`
  
  in the profile settings, go to SSH keys and add the copied key

- get the MetaLab git repo:

		$ sudo apt-get install git
		$ git clone git@github.com:langcog/metalab.git

- install R:
		
		$ sudo nano /etc/apt/sources.list
		add the line
		deb http://cran.rstudio.com/bin/linux/ubuntu trusty/
		[replace trusty/ with correct Ubuntu version if not 14]
		$ sudo apt-get update
		$ sudo apt-get upgrade
		$ sudo apt-get install r-base

- micro instances don't seem to have enough RAM to install dplyr, so add a swapfile to give it more memory (https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04)

		$ sudo fallocate -l 4G /swapfile
		$ sudo chmod 600 /swapfile
		$ sudo mkswap /swapfile
		$ sudo swapon /swapfile

- install R packages:
		$ sudo apt-get install libcurl4-openssl-dev
		$ sudo R
		> install.packages("RCurl", "dplyr", "jsonlite")

- test that the script works:
		$ /home/ubuntu/metalab/scripts/cache_datasets.sh

- set-up a crontab for the script:
		$ crontab -u ubuntu /home/ubuntu/metalab/scripts/cache_datasets_crontab.txt

</xmp>

<script src="strapdown/strapdown.js"></script>
</html>
